<meta charset="UTF-8"> 
<html>

<head>
  <title>LineBot</title>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script> 
  <script src="diff_match_patch.js"></script>

<script type="text/javascript">

var lines = [ ];
// { name: "Fairfax", line: "Hi there Elsie!" },
// 			  { name: "Phoebe", line: "I'm here too you know!" },
// 			  { name: "Elsie", line: "Hi Fairfie" },
// 			  { name: "Fairfax", line: "Wanna hang?" },
// 			  { name: "Elsie", line: "Sure" },
// 			  { name: "Phoebe", line: "I do too!" }
// 			];

var my_name = "Elsie";
var current_index = 0;
var correction_timeout;
var feed_timeout;
var play_timeout;
var feed_words = 3;

var play_line = function() {
	if (current_index >= lines.length) {
		$('#line_entry').hide();
		$('#end').show();
		return false;
	}

	clearTimeout(correction_timeout);
	clearTimeout(feed_timeout);
	$('#correction').empty();
	$('#fed_line').empty();

	var current_line = lines[current_index];
	if (current_line.name == my_name) {
		$('#line_entry').show();
		return false;
	}

	$('#dialog').append("<p><b>" + current_line.name + ": </b>" 
						+ current_line.line + "</p>");
	current_index++;
	play_timeout = setTimeout(play_line, 500);
};

var feed_line = function() {
	$('#input_line').val("");
	clearTimeout(feed_timeout);
	$('#fed_line').empty();
	var current_line = lines[current_index].line;
	var words = current_line.split(" ");
	var message = words.slice(0, feed_words).join(" ");
	$('#fed_line').append(message);
	$('#fed_line').show();
	feed_timeout = setTimeout(function() { $('#fed_line').empty(); $('#fed_line').hide() }, 3000);
	feed_words += 3;
	return false;
}

var check_line = function() {
	console.log("checking");
	clearTimeout(correction_timeout);
	$('#correction').empty();
	var input_line = $('#input_line').val();
	if (input_line == "" || current_index >= lines.length) {
		return false;
	}

	if (input_line == "/line") {
		feed_line();
		return false;
	}

	feed_words = 3;

	if (input_line.toLowerCase() == lines[current_index].line.toLowerCase()) {
		 $('#dialog').append("<p><b>" + lines[current_index].name + ": </b>"
		 					+ lines[current_index].line + "</p>");
		current_index++;
		$('#input_line').val("");
		// console.log(current_index);
		play_line();
	} else {
		var dmp = new diff_match_patch();
		var d = dmp.diff_main(lines[current_index].line.toLowerCase(), input_line.toLowerCase());
		dmp.diff_cleanupSemantic(d);
		dmp.diff_cleanupEfficiency(d);
		var ds = dmp.diff_prettyHtml(d);
		$('#correction').append(ds);
		correction_timeout = setTimeout(function() { $('#correction').empty(); }, 5000);
//		document.getElementById('outputdiv').innerHTML = ds + '<BR>Time: ' + (ms_end - ms_start) / 1000 + 's';

		$('#input_line').val("");
	}
};

var parse_text = function() {
	var text = $('#text').val();
	var sides = text.split("\n\n");
	for (var i = 0; i < sides.length; i++) {
		var side = sides[i];
		var parts = side.split(": ");
		var who = parts[0]; var what = parts[1];
		lines.push({ name: who, line: what });
	}
	$('#text_ctr').hide();
	$('#play_ctr').show();
	my_name = $('#name').val();
	play_line();
//	return false;
}

$(function() {
	$('#play_ctr').hide();
	$('#fed_line').hide();
	$('#end').hide();
	console.log("loading");
    $('#input_line').on("keypress", function(e) {
	if (e.keyCode == 13) {
		console.log("got here");
	    check_line();
	    return false;
	}
    });
	$('#text_submit').click(parse_text);
//	play_line();
});
  
</script>


</head>

<body>

<div id="text_ctr">
<p>Enter the lines.  Format:
<pre>
Name1: ... 
[blank line]
Name2: ...
</pre>
  <form>
<p>	<textarea id="text">
	</textarea>
<p><b>Your character's name:</b>&nbsp;<input type="text" id="name"/>
<p>	<input type="button" id="text_submit" value="Play"/>
  </form>
</div>

<div id="play_ctr">
	<div id="dialog">
	</div>

	<form id="line_entry">
	  <b>Your line:</b>&nbsp;<input type="text" id="input_line" /> (say /line for progressively more help)
	</form>

	<div id="correction">
	</div>

    <div id="fed_line">
    </div>

	<div id="end">
	  <h2>The end</h2>
	</div>
</div>
